name: Claudeæ—¥æœ¬èªã‚³ãƒ¼ãƒ‰ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ

# æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
on:
  # PRã‚„Issueã‚³ãƒ¡ãƒ³ãƒˆã§@claudeã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ãŸæ™‚ã®ã¿å®Ÿè¡Œ
  issue_comment:
    types: [created]
  
  # GitHub UIã‹ã‚‰ã®æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      review_type:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¨®é¡'
        required: true
        default: 'general'
        type: choice
        options:
        - general
        - security
        - performance
        - clean-architecture
      target_pr:
        description: 'PRç•ªå·ï¼ˆç©ºç™½ã®å ´åˆã¯æœ€æ–°PRï¼‰'
        required: false
        type: string

jobs:
  claude-review:
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å‹•ä½œ
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@claude') &&
       github.event.issue.pull_request != null)
    
    runs-on: ubuntu-latest
    timeout-minutes: 20  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã§ã‚³ã‚¹ãƒˆåˆ¶å¾¡
    
    steps:
      - name: ğŸ’° å®Ÿè¡Œå‰ã®æ®‹é«˜ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ¦ Claudeå®Ÿè¡Œå‰ã®APIä½¿ç”¨çŠ¶æ³ç¢ºèª..."
          usage_response=$(curl -s -w "%{http_code}" -o usage.json \
            -H "Authorization: Bearer ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.anthropic.com/v1/usage)
          
          http_code="${usage_response: -3}"
          if [ "$http_code" = "200" ]; then
            total_cost=$(cat usage.json | jq -r '.total_cost // 0')
            echo "ğŸ’µ ä»Šæœˆã®ä½¿ç”¨æ–™é‡‘: \${total_cost}"
            if (( $(echo "$total_cost > 10" | bc -l) )); then
              echo "âš ï¸  è­¦å‘Š: ä»Šæœˆã®ä½¿ç”¨æ–™é‡‘ãŒ$10ã‚’è¶…ãˆã¦ã„ã¾ã™"
            fi
          fi
          
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          # PRã®å¤‰æ›´ã‚‚å«ã‚ã¦å–å¾—
          fetch-depth: 0
          
      - name: Claudeã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          max_turns: 5  # ä¼šè©±ã‚¿ãƒ¼ãƒ³æ•°åˆ¶é™ã§ã‚³ã‚¹ãƒˆåˆ¶å¾¡
          
          # æ—¥æœ¬èªãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          prompt: |
            ## æŒ‡ç¤º
            ã“ã®PRã‚’**æ—¥æœ¬èªã§**ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
            
            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.review_type == 'security' && 'ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡ç‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼**' || 
                github.event_name == 'workflow_dispatch' && github.event.inputs.review_type == 'performance' && 'âš¡ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡ç‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼**' || 
                github.event_name == 'workflow_dispatch' && github.event.inputs.review_type == 'clean-architecture' && 'ğŸ—ï¸ **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é‡ç‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼**' || 
                'ğŸ“‹ **ç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼**' }}
            
            ### ãƒã‚§ãƒƒã‚¯é …ç›®
            - ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ã€è„†å¼±æ€§ã®æœ‰ç„¡
            - ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: åŠ¹ç‡çš„ãªã‚³ãƒ¼ãƒ‰ã€ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡
            - ğŸ“– å¯èª­æ€§: ã‚³ãƒ¡ãƒ³ãƒˆã€å‘½åè¦å‰‡ã€æ§‹é€ ã®æ˜ç¢ºã•
            - ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: è²¬å‹™åˆ†é›¢ã€ä¾å­˜é–¢ä¿‚ã€å±¤ã®ç‹¬ç«‹æ€§
            - ğŸ”„ SOLIDåŸå‰‡: å˜ä¸€è²¬ä»»ã€é–‹æ”¾é–‰é–ã€ä¾å­˜é–¢ä¿‚é€†è»¢ãªã©
            - ğŸ§ª ãƒ†ã‚¹ãƒˆ: ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€ãƒ¢ãƒƒã‚¯å®¹æ˜“æ€§ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
            
            ## å‡ºåŠ›å½¢å¼
            ### âœ… è‰¯ã„ç‚¹
            - [è‰¯ã„å®Ÿè£…ã«ã¤ã„ã¦]
            
            ### âš ï¸ æ”¹å–„ææ¡ˆ
            - [å…·ä½“çš„ãªæ”¹å–„ç‚¹]
            
            ### ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªå•é¡Œ
            - [é‡è¦ãªå•é¡Œç‚¹]
            
            ## æ³¨æ„äº‹é …
            - **ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¨˜è¿°**
            - ç°¡æ½”ã§è¦ç‚¹ã‚’çµã£ãŸå†…å®¹ã«ã™ã‚‹ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
            - é‡è¦åº¦ã®é«˜ã„å•é¡Œã‚’å„ªå…ˆçš„ã«æŒ‡æ‘˜
            - ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ç¤ºã™å ´åˆã¯æœ€å°é™ã«ç•™ã‚ã‚‹
            
      - name: å®Ÿè¡Œå¾Œã®ä½¿ç”¨é‡ç¢ºèª
        if: always()
        run: |
          echo "ğŸ“Š Claudeå®Ÿè¡Œå¾Œã®APIä½¿ç”¨çŠ¶æ³..."
          usage_response=$(curl -s -w "%{http_code}" -o usage_after.json \
            -H "Authorization: Bearer ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.anthropic.com/v1/usage)
          
          http_code="${usage_response: -3}"
          if [ "$http_code" = "200" ]; then
            total_cost=$(cat usage_after.json | jq -r '.total_cost // 0')
            echo "ğŸ’µ å®Ÿè¡Œå¾Œã®ä»Šæœˆä½¿ç”¨æ–™é‡‘: \${total_cost}"
            echo "ğŸŒ è©³ç´°: https://console.anthropic.com/settings/billing"
          fi
          
      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†é€šçŸ¥
        if: success()
        run: |
          echo "âœ… Claudeæ—¥æœ¬èªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸ"